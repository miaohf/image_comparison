# 多阶段分析Workflow系统

## 概述

为了解决相同图片被误判为有差异，以及不同图片被误判为相同的问题，我们实现了一个基于agent/workflow的多阶段分析系统。

## 系统架构

### 多阶段分析流程

```
输入图片 → 阶段1: 基础相似度计算 → 阶段2: 特征提取和比较 → 阶段3: 内容差异检测 → 阶段4: 结果整合和验证 → 阶段5: 告警详情生成 → 阶段6: 分析摘要生成 → 输出结果
```

### 各阶段详细说明

#### 阶段1: 基础相似度计算 (权重: 30%)
- **功能**: 像素级比较，计算均方误差(MSE)
- **方法**: 
  - 将图片统一缩放到224x224像素
  - 转换为RGB格式
  - 计算像素级均方误差
  - 转换为相似度分数(0-1)
- **优势**: 客观、快速、不受AI模型影响
- **适用**: 检测完全相同的图片

#### 阶段2: 特征提取和比较 (权重: 20%)
- **功能**: 分析图片的颜色、亮度、对比度等特征
- **方法**:
  - 提取RGB通道的均值和标准差
  - 计算灰度图像的亮度和对比度
  - 比较特征差异
  - 计算特征相似度
- **优势**: 能够检测到颜色、亮度等变化
- **适用**: 检测环境变化、光线变化

#### 阶段3: 内容差异检测 (权重: 50%)
- **功能**: 使用AI模型分析内容差异
- **方法**:
  - 调用Qwen2.5 VL模型
  - 使用优化的提示词
  - 检测人物、物体、设备状态变化
  - 如果基础相似度很高但AI报告差异，进行二次验证
- **优势**: 能够理解图片语义内容
- **适用**: 检测人物出现、设备状态变化等

#### 阶段4: 结果整合和验证
- **功能**: 整合三个阶段的结果
- **方法**:
  - 加权计算最终相似度
  - 合并差异信息
  - 过滤低置信度差异
  - 确定告警级别
- **优势**: 综合多个维度的分析结果

#### 阶段5: 告警详情生成
- **功能**: 生成详细的告警信息
- **内容**:
  - 严重程度评估
  - 告警类别分类
  - 影响范围分析
  - 建议措施
  - 风险等级
  - 预估解决时间

#### 阶段6: 分析摘要生成
- **功能**: 生成简洁的分析摘要
- **内容**: 总体情况概述，便于快速理解

## 优化策略

### 1. 误判过滤机制
- 当相似度 > 0.98时，直接返回"相同"结果
- 当相似度 > 0.95但AI报告差异时，过滤低置信度(< 0.9)差异
- 使用计算得到的相似度，而不是AI返回的相似度

### 2. 二次验证机制
- 当基础相似度与AI相似度差异很大时，进行详细分析
- 使用更详细的提示词进行二次检测
- 特别关注人物、物体、设备状态变化

### 3. 特征差异补偿
- 如果特征分析显示有明显差异，但内容分析没有检测到，添加特征差异
- 特征差异超过阈值时，生成相应的差异报告

## 提示词优化

### 重点关注的变化
1. **人物**: 人的出现、消失、移动、姿势变化
2. **物体**: 物体的增加、减少、移动、状态变化
3. **设备**: 指示灯、显示屏、开关状态的变化
4. **环境**: 明显的环境变化（如灯光、烟雾、液体泄漏等）

### 忽略的变化
- 微小的光线变化
- 阴影的轻微差异
- 压缩伪影
- 时间戳的差异
- 摄像头角度的微小变化

## 性能优化

### 1. 并行处理
- 基础相似度和特征分析可以并行进行
- 减少总体处理时间

### 2. 缓存机制
- 缓存已计算的特征
- 避免重复计算

### 3. 早期终止
- 如果基础相似度很高，跳过部分分析阶段
- 提高处理效率

## 测试和验证

### 测试脚本
- `test_workflow.py`: 测试多阶段分析workflow
- `test_similarity.py`: 测试相似度计算准确性

### 测试场景
1. **相同图片**: 应该返回高相似度和0个差异
2. **相似图片**: 应该返回中等相似度和少量差异
3. **不同图片**: 应该返回低相似度和多个差异
4. **监控场景**: 特别测试人物出现、设备状态变化等

## 配置参数

### 相似度阈值
- **相同图片**: > 0.95 (95%)
- **相似图片**: 0.8-0.95 (80%-95%)
- **不同图片**: < 0.8 (80%)

### 权重配置
- 基础相似度: 30%
- 特征分析: 20%
- 内容分析: 50%

### 置信度阈值
- 高置信度: > 0.9 (90%)
- 中等置信度: 0.7-0.9 (70%-90%)
- 低置信度: < 0.7 (70%)

## 监控和日志

### 日志输出
- 每个阶段的处理结果
- 相似度分数
- 检测到的差异数量
- 处理时间

### 性能监控
- 各阶段耗时统计
- 准确率统计
- 误判率统计

## 未来改进

### 1. 深度学习模型
- 集成更先进的图像相似度模型
- 使用预训练的视觉模型进行特征提取

### 2. 自适应权重
- 根据图片类型自动调整权重
- 学习最优的权重配置

### 3. 实时学习
- 根据用户反馈调整模型
- 持续优化分析准确性

### 4. 多模态分析
- 结合时间序列信息
- 集成音频、传感器数据

## 总结

多阶段分析workflow系统通过结合传统的图像处理方法、特征分析和AI内容理解，显著提高了图片差异检测的准确性。系统能够：

1. **准确识别相同图片**: 避免误报
2. **检测重要变化**: 重点关注人物、设备状态等
3. **忽略无关变化**: 过滤光线、阴影等微小变化
4. **提供详细分析**: 生成可操作的告警信息

这个系统特别适合监控场景，能够有效检测安全相关的变化，同时减少误报。 